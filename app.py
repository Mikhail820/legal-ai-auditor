import streamlit as st
import google.generativeai as genai
from PyPDF2 import PdfReader
from docx import Document
import time

# 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
st.set_page_config(page_title="LegalAI Auditor 2026", page_icon="‚öñÔ∏è")

# 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏ (–ò—Å–ø–æ–ª—å–∑—É–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é Gemini 3 Flash)
if "GOOGLE_API_KEY" in st.secrets:
    genai.configure(api_key=st.secrets["GOOGLE_API_KEY"])
    # –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –º–æ–¥–µ–ª–∏ 2.5/3 –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –æ—à–∏–±–∫—É 404 (Not Found)
    model = genai.GenerativeModel('models/gemini-3-flash') 
else:
    st.error("–ö–ª—é—á API –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Secrets!")
    st.stop()

# 3. –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
st.title("‚öñÔ∏è –Æ—Ä–∏—Å—Ç-–ê—É–¥–∏—Ç–æ—Ä 2026")
st.markdown("---")
st.info("–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–æ–¥–µ–ª—å Gemini 3 Flash. –õ–∏–º–∏—Ç: 15 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É.")

# –í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
cat = st.selectbox("–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞:", [
    "–ë–∞–Ω–∫–æ–≤—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ (–∫–∞—Ä—Ç—ã, –≤–∫–ª–∞–¥—ã)", 
    "–ö—Ä–µ–¥–∏—Ç—ã –∏ –∏–ø–æ—Ç–µ–∫–∞", 
    "–ê—Ä–µ–Ω–¥–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏",
    "–¢—Ä—É–¥–æ–≤–æ–π –¥–æ–≥–æ–≤–æ—Ä",
    "–î—Ä—É–≥–æ–µ"
])

# –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –∏–ª–∏ –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞
file = st.file_uploader("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–≥–æ–≤–æ—Ä (PDF, DOCX, TXT)", type=["pdf", "docx", "txt"])
txt = st.text_area("–ò–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é:", height=200)

# 4. –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
if st.button("üöÄ –ù–∞—á–∞—Ç—å –∞—É–¥–∏—Ç"):
    content = ""
    
    # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏–∑ —Ñ–∞–π–ª–æ–≤
    if file:
        try:
            if file.name.endswith(".pdf"):
                reader = PdfReader(file)
                content = "".join([p.extract_text() for p in reader.pages])
            elif file.name.endswith(".docx"):
                doc = Document(file)
                content = "\n".join([p.text for p in doc.paragraphs])
            else:
                content = file.read().decode("utf-8")
        except Exception as e:
            st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: {e}")
    else:
        content = txt

    # –ó–∞–ø—É—Å–∫ –∞–Ω–∞–ª–∏–∑–∞
    if content:
        # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –≤ Free Tier
        content = content[:20000] 
        
        with st.spinner("–ò–ò –ø—Ä–æ–≤–æ–¥–∏—Ç —é—Ä–∏–¥–∏—á–µ—Å–∫—É—é —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—É..."):
            try:
                # –ü—Ä–æ–º–ø—Ç –¥–ª—è –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
                prompt = f"""–¢—ã –æ–ø—ã—Ç–Ω—ã–π —é—Ä–∏—Å—Ç. –ü—Ä–æ–≤–µ–¥–∏ –∞—É–¥–∏—Ç –¥–æ–≥–æ–≤–æ—Ä–∞ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: {cat}.
                –ù–∞–π–¥–∏ 5 —Å–∞–º—ã—Ö —Å–µ—Ä—å–µ–∑–Ω—ã—Ö —é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö —Ä–∏—Å–∫–æ–≤ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞. 
                –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∏—Å–∫–∞ —É–∫–∞–∂–∏:
                1. –°—É—Ç—å –ø—Ä–æ–±–ª–µ–º—ã.
                2. –°—Å—ã–ª–∫—É –Ω–∞ —Ç–µ–∫—Å—Ç (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ).
                3. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—é, –∫–∞–∫ —ç—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å.
                
                –¢–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞:
                {content}"""
                
                # –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—Ä–æ—Å
                res = model.generate_content(prompt)
                st.success("–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!")
                st.markdown(res.text)
                
            except Exception as e:
                error_str = str(e)
                if "429" in error_str:
                    st.error("–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ (Quota Exceeded). –ü–æ–¥–æ–∂–¥–∏—Ç–µ 60 —Å–µ–∫—É–Ω–¥.")
                elif "404" in error_str:
                    st.warning("–ü—Ä–æ–±—É—é –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é –º–æ–¥–µ–ª—å (Gemini 2.5 Flash)...")
                    try:
                        # –ü–ª–∞–Ω –ë –Ω–∞ —Å–ª—É—á–∞–π —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π Gemini 3
                        alt_model = genai.GenerativeModel('models/gemini-2.5-flash')
                        res = alt_model.generate_content(prompt)
                        st.markdown(res.text)
                    except Exception as e2:
                        st.error(f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {e2}")
                else:
                    st.error(f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")
    else:
        st.warning("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –¥–æ–≥–æ–≤–æ—Ä–∞.")

st.markdown("---")
st.caption("–í–Ω–∏–º–∞–Ω–∏–µ: –¥–∞–Ω–Ω—ã–π –∞—É–¥–∏—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é –∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–µ–π.")
    
