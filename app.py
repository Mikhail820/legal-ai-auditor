import streamlit as st
import google.generativeai as genai
from PyPDF2 import PdfReader
from docx import Document
from PIL import Image

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –°–¢–†–ê–ù–ò–¶–´ ---
st.set_page_config(
    page_title="LegalAI Ultimate ‚Äî –í–∞—à –ò–ò-–Æ—Ä–∏—Å—Ç", 
    page_icon="üõ°Ô∏è", 
    layout="wide"
)

# --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ò ---
if "GOOGLE_API_KEY" in st.secrets:
    genai.configure(api_key=st.secrets["GOOGLE_API_KEY"])
    model = genai.GenerativeModel('models/gemini-3-flash')
else:
    st.error("–û—à–∏–±–∫–∞: API –∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ Secrets!")
    st.stop()

# --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
def extract_text_from_file(file):
    try:
        if file.name.endswith(".pdf"):
            reader = PdfReader(file)
            return "".join([page.extract_text() for page in reader.pages])
        elif file.name.endswith(".docx"):
            doc = Document(file)
            return "\n".join([para.text for para in doc.paragraphs])
        else:
            return file.read().decode("utf-8")
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ {file.name}: {e}")
        return ""

# --- –ò–ù–¢–ï–†–§–ï–ô–° (–ú–ê–†–ö–ï–¢–ò–ù–ì–û–í–´–ô –ë–õ–û–ö) ---
st.title("üõ°Ô∏è LegalAI Ultimate 2026")
st.subheader("–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π –∞—É–¥–∏—Ç –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –∏ –∑–∞—â–∏—Ç–∞ –≤–∞—à–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤")

# –ö–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤
col_m1, col_m2, col_m3 = st.columns(3)
with col_m1:
    st.info("üîç **–ì–ª—É–±–æ–∫–∏–π –∞—É–¥–∏—Ç**\n\n–ü–æ–∏—Å–∫ —Å–∫—Ä—ã—Ç—ã—Ö –ª–æ–≤—É—à–µ–∫, —à—Ç—Ä–∞—Ñ–æ–≤ –∏ –∫–∞–±–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π –∑–∞ —Å–µ–∫—É–Ω–¥—ã.")
with col_m2:
    st.success("‚öñÔ∏è **–ü—Ä–æ—Ç–æ–∫–æ–ª –ø—Ä–∞–≤–æ–∫**\n\n–ì–æ—Ç–æ–≤—ã–µ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ –¥–ª—è –∑–∞–º–µ–Ω—ã –æ–ø–∞—Å–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤.")
with col_m3:
    st.warning("üîç **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π**\n\n–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –¥–æ–≥–æ–≤–æ—Ä–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –Ω–æ–≤—ã—Ö ¬´—Å—é—Ä–ø—Ä–∏–∑–æ–≤¬ª.")

st.markdown("---")

# --- –û–°–ù–û–í–ù–û–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ ---
tab1, tab2 = st.tabs(["üßê –ì–ª—É–±–æ–∫–∏–π –∞—É–¥–∏—Ç –∏ OCR", "üîç –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–≤—É—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤"])

# –í–ö–õ–ê–î–ö–ê 1: –ê–£–î–ò–¢
with tab1:
    c1, c2 = st.columns([1, 1])
    
    with c1:
        st.write("### 1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç")
        category = st.selectbox("–°—Ñ–µ—Ä–∞ –¥–æ–≥–æ–≤–æ—Ä–∞:", 
            ["–ë–∞–Ω–∫–æ–≤—Å–∫–æ–µ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ", "–ö—Ä–µ–¥–∏—Ç—ã –∏ –∏–ø–æ—Ç–µ–∫–∞", "–ê—Ä–µ–Ω–¥–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏", "–¢—Ä—É–¥–æ–≤–æ–π –¥–æ–≥–æ–≤–æ—Ä", "IT-—É—Å–ª—É–≥–∏/NDA", "–î—Ä—É–≥–æ–µ"])
        
        uploaded_file = st.file_uploader("–ó–∞–≥—Ä—É–∑–∏—Ç–µ PDF, DOCX –∏–ª–∏ –§–û–¢–û –¥–æ–≥–æ–≤–æ—Ä–∞", type=["pdf", "docx", "jpg", "png", "jpeg"])
        
        analyze_button = st.button("üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç")

    with c2:
        st.write("### 2. –†–µ–∑—É–ª—å—Ç–∞—Ç —ç–∫—Å–ø–µ—Ä—Ç–∏–∑—ã")
        if analyze_button:
            if uploaded_file:
                with st.spinner("–ò–ò –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –∏ —Å–≤–µ—Ä—è–µ—Ç—Å—è —Å –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ–º –†–§..."):
                    try:
                        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ (OCR) –∏–ª–∏ —Ç–µ–∫—Å—Ç–∞
                        if uploaded_file.type in ["image/jpeg", "image/png"]:
                            img = Image.open(uploaded_file)
                            st.image(img, caption="–°–∫–∞–Ω –¥–æ–∫—É–º–µ–Ω—Ç–∞ –ø—Ä–∏–Ω—è—Ç", width=300)
                            prompt = [f"–¢—ã - —Å—Ç–∞—Ä—à–∏–π —é—Ä–∏—Å—Ç. –ü—Ä–æ–≤–µ–¥–∏ –∞—É–¥–∏—Ç —ç—Ç–æ–≥–æ —Å–∫–∞–Ω–∞ –¥–æ–≥–æ–≤–æ—Ä–∞ ({category}). –ù–∞–π–¥–∏ 5 —Ä–∏—Å–∫–æ–≤ –∏ –Ω–∞–ø–∏—à–∏ –ø—Ä–æ—Ç–æ–∫–æ–ª —Ä–∞–∑–Ω–æ–≥–ª–∞—Å–∏–π.", img]
                        else:
                            text_content = extract_text_from_file(uploaded_file)
                            prompt = f"""–¢—ã - –≤–µ–¥—É—â–∏–π —é—Ä–∏—Å—Ç –†–§. –ü—Ä–æ–≤–µ–¥–∏ –∞—É–¥–∏—Ç –¥–æ–≥–æ–≤–æ—Ä–∞: {category}.
                            
                            –ó–ê–î–ê–ß–ò:
                            1. –ü–æ—Å—Ç–∞–≤—å –≤–µ—Ä–¥–∏–∫—Ç: üî¥ –û–ø–∞—Å–Ω–æ, üü° –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏–ª–∏ üü¢ –ë–µ–∑–æ–ø–∞—Å–Ω–æ.
                            2. –û–±—ä—è—Å–Ω–∏ —Å—É—Ç—å –¥–æ–≥–æ–≤–æ—Ä–∞ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏ –¥–ª—è –æ–±—ã—á–Ω–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞.
                            3. –ù–∞–π–¥–∏ 5 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–∏—Å–∫–æ–≤ —Å–æ —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ —Å—Ç–∞—Ç—å–∏ –ì–ö –†–§ –∏–ª–∏ –ó–æ–ó–ü–ü.
                            4. –°–æ—Å—Ç–∞–≤—å –ü—Ä–æ—Ç–æ–∫–æ–ª —Ä–∞–∑–Ω–æ–≥–ª–∞—Å–∏–π: –¢–∞–±–ª–∏—Ü–∞ '–ü—É–Ω–∫—Ç' | '–í —á–µ–º —Ä–∏—Å–∫' | '–ü—Ä–µ–¥–ª–∞–≥–∞–µ–º–∞—è —Ä–µ–¥–∞–∫—Ü–∏—è'.
                            
                            –¢–µ–∫—Å—Ç –¥–æ–≥–æ–≤–æ—Ä–∞:
                            {text_content[:20000]}"""

                        response = model.generate_content(prompt)
                        st.markdown(response.text)
                        st.download_button("üíæ –°–∫–∞—á–∞—Ç—å –∑–∞–∫–ª—é—á–µ–Ω–∏–µ", response.text, file_name="legal_audit.txt")
                    except Exception as e:
                        st.error(f"–û—à–∏–±–∫–∞ –ò–ò: {e}")
            else:
                st.warning("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.")

# –í–ö–õ–ê–î–ö–ê 2: –°–†–ê–í–ù–ï–ù–ò–ï
with tab2:
    st.write("### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–æ–∫")
    st.write("–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç –ø—Ä–∏—Å–ª–∞–ª –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é? –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ –æ–Ω –≤–Ω–µ—Å –ø—Ä–∞–≤–∫–∏ –∏ –Ω–µ –¥–æ–±–∞–≤–∏–ª –ª–∏ —á—Ç–æ-—Ç–æ –æ—Ç —Å–µ–±—è.")
    
    diff_col1, diff_col2 = st.columns(2)
    old_f = diff_col1.file_uploader("–°—Ç–∞—Ä–∞—è –≤–µ—Ä—Å–∏—è (–í–∞—à–∞)", type=["pdf", "docx"], key="old_ver")
    new_f = diff_col2.file_uploader("–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è (–û—Ç –Ω–∏—Ö)", type=["pdf", "docx"], key="new_ver")
    
    if st.button("üîé –ù–∞–π—Ç–∏ –æ—Ç–ª–∏—á–∏—è"):
        if old_f and new_f:
            with st.spinner("–°—Ä–∞–≤–Ω–∏–≤–∞—é –¥–æ–∫—É–º–µ–Ω—Ç—ã..."):
                old_txt = extract_text_from_file(old_f)
                new_txt = extract_text_from_file(new_f)
                
                compare_prompt = f"""–¢—ã —é—Ä–∏—Å—Ç-–∞–Ω–∞–ª–∏—Ç–∏–∫. –°—Ä–∞–≤–Ω–∏ –¥–≤–µ –≤–µ—Ä—Å–∏–∏ –¥–æ–≥–æ–≤–æ—Ä–∞. 
                –ù–∞–π–¥–∏ –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –£–∫–∞–∂–∏, –±—ã–ª–∏ –ª–∏ –ø—Ä–∏–Ω—è—Ç—ã –Ω–∞—à–∏ –ø—Ä–∞–≤–∫–∏. 
                –ü—Ä–æ–≤–µ—Ä—å, –Ω–µ –ø–æ—è–≤–∏–ª–∏—Å—å –ª–∏ –≤ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏ —Å–∫—Ä—ã—Ç—ã–µ –Ω–µ–≤—ã–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è.
                
                –¢–ï–ö–°–¢ 1: {old_txt[:10000]}
                –¢–ï–ö–°–¢ 2: {new_txt[:10000]}"""
                
                res = model.generate_content(compare_prompt)
                st.info("–û—Ç—á–µ—Ç –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö:")
                st.markdown(res.text)
        else:
            st.warning("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–±–∞ —Ñ–∞–π–ª–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è.")

# --- –ü–û–î–í–ê–õ ---
st.markdown("---")
st.caption("LegalAI Ultimate 2026. –î–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç –∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∑–∞–º–µ–Ω–æ–π –æ—á–Ω–æ–π —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.")
            
